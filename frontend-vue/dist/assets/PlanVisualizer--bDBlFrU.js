import{d as A,r,o as W,w as X,c as U,b as p,e as a,f as C,g as Y,h as o,E as G,i as H,l as g,m as J,n as K,F as Z,p as ee,O as le,q as ae,u as te,v as b,P as oe,Q as se,R as ne,S as E,T as re,x as ue,y as ie,U as ce,V as de,W as pe,X as w,Y as ve,_ as _e}from"./index-BCQt_NF5.js";/* empty css                  *//* empty css                 */import{a as x}from"./api-DESwUr0w.js";const me={class:"page-container"},ge={class:"sql-content"},fe={class:"pagination-container"},be=A({__name:"PlanVisualizer",setup(we){const B=ve(),y=r(null),s=r(""),z=r([]),h=r(!1),m=r(""),u=r(1),i=r(20),S=r(0),c=r(""),d=r("all");W(async()=>{try{const t=await x.getCollections();y.value=t,t.collections.length>0&&(s.value=t.collections[0])}catch{m.value="加载集合列表失败"}}),X([s,u,c,d],async()=>{s.value&&await P()});const P=async()=>{var t,e;h.value=!0,m.value="";try{console.log("正在加载计划列表，集合:",s.value,"搜索:",c.value,"状态:",d.value);let n;if(c.value||d.value!=="all"){const v={};c.value&&(v.q=c.value),d.value!=="all"&&(v.status=d.value),n=await x.searchPlans(s.value,v,u.value,i.value)}else n=await x.getPlans(s.value,u.value,i.value);console.log("计划列表加载成功:",n),z.value=n.items,S.value=n.total}catch(n){console.error("加载计划列表失败:",n),m.value=`加载计划列表失败: ${((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.detail)||n.message||"未知错误"}`}finally{h.value=!1}},L=(t,e)=>{u.value=t,e&&e!==i.value&&(i.value=e)},Q=t=>{i.value=t,u.value=1},T=t=>{s.value=t,u.value=1},I=async()=>{s.value&&(u.value=1,await P())},N=t=>{try{if(console.log("=== 开始查看执行计划 ==="),console.log("record数据:",t),console.log("record._id:",t._id),console.log("selectedCollection.value:",s.value),!t._id||t._id.trim()===""){w.error("该数据条目缺少有效的ID，无法查看执行计划");return}if(!s.value){w.error("缺少集合信息，无法查看执行计划");return}if(t.status==="error"){w.warning("该查询执行失败，无法查看执行计划");return}B.push({name:"PEV2Viewer",query:{id:t._id.trim(),collection:s.value}}),console.log("=== 跳转到PEV2Viewer页面 ===")}catch(e){console.error("=== 查看计划失败 ==="),console.error("错误类型:",typeof e),console.error("错误信息:",e),console.error("错误堆栈:",e.stack),w.error("跳转到查询计划可视化页面失败: "+e.message)}};return(t,e)=>{const n=ae,v=K,V=J,D=le,k=te,q=G,F=H,_=ne,M=re,O=ue,R=de,$=pe,j=se;return g(),U("div",me,[e[9]||(e[9]=p("div",{class:"page-header"},[p("h2",{class:"page-title"},"执行计划"),p("p",{class:"page-description"},"查看和分析SQL查询执行计划")],-1)),a(q,{class:"card-container"},{default:o(()=>[a(V,{direction:"vertical",style:{width:"100%"}},{default:o(()=>[a(V,{style:{width:"100%"}},{default:o(()=>[e[5]||(e[5]=p("span",null,"选择数据集合:",-1)),a(v,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=l=>s.value=l),onChange:T,style:{width:"200px"},disabled:!y.value},{default:o(()=>{var l;return[(g(!0),U(Z,null,ee((l=y.value)==null?void 0:l.collections,f=>(g(),C(n,{key:f,label:f,value:f},null,8,["label","value"]))),128))]}),_:1},8,["modelValue","disabled"])]),_:1}),a(V,{style:{width:"100%"}},{default:o(()=>[e[7]||(e[7]=p("span",null,"搜索查询:",-1)),a(D,{modelValue:c.value,"onUpdate:modelValue":e[1]||(e[1]=l=>c.value=l),placeholder:"输入SQL关键字搜索",style:{width:"200px"},clearable:""},null,8,["modelValue"]),a(v,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=l=>d.value=l),style:{width:"150px"}},{default:o(()=>[a(n,{label:"全部状态",value:"all"}),a(n,{label:"成功",value:"success"}),a(n,{label:"失败",value:"error"})]),_:1},8,["modelValue"]),a(k,{type:"primary",onClick:I,disabled:!s.value},{default:o(()=>[...e[6]||(e[6]=[b(" 搜索 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1}),m.value?(g(),C(F,{key:0,title:"错误",description:m.value,type:"error",style:{"margin-bottom":"24px"}},null,8,["description"])):Y("",!0),a(q,null,{default:o(()=>[oe((g(),C(R,{data:z.value,"row-key":"_id",border:"",resizable:"","default-sort":{prop:"execution_time_ms",order:"descending"}},{default:o(()=>[a(_,{prop:"sql_content",label:"SQL内容","min-width":"200","show-overflow-tooltip":"",resizable:""},{default:o(({row:l})=>[p("div",ge,E(l.sql_content),1)]),_:1}),a(_,{prop:"execution_time_ms",label:"执行时间",width:"120",sortable:"",resizable:""},{default:o(({row:l})=>[b(E(l.execution_time_ms.toFixed(2))+"ms ",1)]),_:1}),a(_,{prop:"row_count",label:"返回行数",width:"120",sortable:"",resizable:""}),a(_,{prop:"status",label:"状态",width:"100",resizable:""},{default:o(({row:l})=>[a(M,{type:l.status==="success"?"success":l.status==="error"?"danger":"warning"},{default:o(()=>[b(E(l.status==="success"?"成功":l.status==="error"?"失败":"未知"),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"file_name",label:"文件名",width:"150","show-overflow-tooltip":"",resizable:""}),a(_,{label:"操作",width:"100",fixed:"right",resizable:""},{default:o(({row:l})=>[a(k,{type:"primary",link:"",onClick:f=>N(l)},{default:o(()=>[a(O,null,{default:o(()=>[a(ie(ce))]),_:1}),e[8]||(e[8]=b(" 查看 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[j,h.value]]),p("div",fe,[a($,{"current-page":u.value,"onUpdate:currentPage":e[3]||(e[3]=l=>u.value=l),"page-size":i.value,"onUpdate:pageSize":e[4]||(e[4]=l=>i.value=l),"page-sizes":[10,20,50,100],total:S.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:L},null,8,["current-page","page-size","total"])])]),_:1})])}}}),Ee=_e(be,[["__scopeId","data-v-d2504a6a"]]);export{Ee as default};
